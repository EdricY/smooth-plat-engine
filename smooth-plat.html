<!DOCTYPE html>
<html>
<head>
<script>
var loadedResrcs = 0;
const RESRCS_TO_LOAD = 2;
function resrcLoaded() { loadedResrcs++; }
</script>
</head>
<body>
<div id="loadmsg">Loading...</div>
<canvas id="canvas" width="960" height="720"></canvas>
<canvas hidden id="renderer" width="960" height="720"></canvas>
</body>
<img hidden id='mapImg' src='collision-map.png' alt='img' onload="resrcLoaded()">
<img hidden id='psprites' src='hector_greatlord_armads.png' alt='psprites' onload="resrcLoaded()">

<script src="constants.js"></script>
<script src="collisionMap.js"></script>
<script src="animator.js"></script>
<script src="player.js"></script>
<script src="frames.js"></script>
<script>
// declarations
var canvas = document.getElementById('canvas')
var renderer = document.getElementById('renderer')
var mapImg = document.getElementById('mapImg')
var psprites = document.getElementById('psprites')
 
var vis_ctx = canvas.getContext('2d')
var ctx = renderer.getContext('2d')

const backgroundColor = '#333'

var cMap;
var player;
var gameInt
var lastTime = Date.now();
var keys = {};
var lastKeys = {};

var loadInterval = setInterval(attemptInit, 500);
function attemptInit() {
    if (loadedResrcs == RESRCS_TO_LOAD) {
        ctx.drawImage(mapImg, 0, 0)
        cMap = new CollisionMap(getCanvasImageData(ctx));
        player = new Player();
        loadmsg.parentNode.removeChild(loadmsg);
        gameInt = setInterval(tick, 1);
        flushToCanvas()
        clearInterval(loadInterval)
    }
}

function getCanvasImageData(ctx) {
    return ctx.getImageData(0, 0, W, H).data;
    // data = []
    // raw_data = ctx.getImageData(0, 0, W, H).data
    // for (let row = 0; row < H; row++) {
    //     data.push([])
    //     for (let col = 0; col < W; col++) {
    //         let pos = 4 * (col + row*W);
    //         let colorstr = raw_data.slice(pos, pos+4).toString()
    //         let tileid = TILES[colorstr]
    //         data[row].push(tileid);
    //     }
    // }
    // return data
}

function draw() {
    ctx.drawImage(mapImg, 0, 0);
    player.draw(ctx);
    drawHUD()
}

function update() {
    player.update(cMap, keys, lastKeys)
    lastKeys = JSON.parse(JSON.stringify(keys)); //deep copy
}

function tick() {
    if (Date.now() - lastTime > 16) {
        lastTime = Date.now();
        update();
    }
    // Particles.update();
    draw();
}


function flushToCanvas() {
    vis_ctx.drawImage(renderer, 0, 0); //flush to canvas
    requestAnimationFrame(flushToCanvas);
}

onkeydown = e => {
	let k = e.keyCode;
	keys[k] = true;
}

onkeyup = e => {
	let k = e.keyCode;
	keys[k] = false;
}

function drawHUD() {
	ctx.fillStyle = "yellow";
	ctx.font = "20px serif";
	ctx.textAlign = "right"
	properties = [
		'player.x',
		'player.y',
		'player.vx',
		'player.vy',
        'player.midair',
        'player.state',
        'player.frameStep',
	]

	let spacing = 20;
	for (let i in properties){
		let s = properties[i];
		let displayStr = s;
		displayStr += ': ' + eval(s)
		ctx.fillText(displayStr, canvas.width - spacing, spacing + spacing*i)
	}
}

function STOP() {
    clearInterval(gameInt);
}
</script>
